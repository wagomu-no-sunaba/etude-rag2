# ============================================
# Cloud Build設定 - API Server
# Kanikoを使用してレイヤーキャッシュをArtifact Registryに保存
# ============================================

substitutions:
  _REGION: us-central1
  _REPOSITORY: etude-rag2-repo

options:
  machineType: 'E2_HIGHCPU_8'

steps:
  - name: 'gcr.io/kaniko-project/executor:latest'
    args:
      - '--dockerfile=Dockerfile'
      - '--destination=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/api-server:latest'
      - '--destination=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/api-server:$COMMIT_SHA'
      - '--cache=true'
      - '--cache-repo=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/cache'
      - '--cache-ttl=168h'
      - '--build-arg=BASE_IMAGE=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/base:latest'

timeout: '600s'
